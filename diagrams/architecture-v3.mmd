graph TD
    subgraph ç”¨æˆ·å±‚["ğŸ¤ ç”¨æˆ·äº¤äº’å±‚"]
        UI["UIæ§åˆ¶é¢æ¿"]
        THEME["ä¸»é¢˜/æ ·å¼é…ç½®"]
    end

    subgraph å¤šç»´éŸ³é¢‘è¾“å…¥["ğŸµ å¤šç»´éŸ³é¢‘è¾“å…¥å±‚"]
        MIC["éº¦å…‹é£è¾“å…¥<br/>(MediaStream)"]
        VOL["ğŸ”Š éŸ³é‡ Volume<br/>(RMS/PeakæŒ¯å¹…)"]
        PITCH["ğŸµ éŸ³è°ƒ Pitch<br/>(åŸºé¢‘F0æ£€æµ‹)"]
        SPEED["ğŸ—£ï¸ è¯­é€Ÿ Speed<br/>(VADè¯­éŸ³æ´»åŠ¨ç‡)"]
        EMO["ğŸ’œ æƒ…æ„Ÿ Emotion<br/>(è¯­è°ƒ/èƒ½é‡/èŠ‚å¥ç‰¹å¾)"]
        MIC --> VOL
        MIC --> PITCH
        MIC --> SPEED
        MIC --> EMO
    end

    subgraph çŠ¶æ€ç®¡ç†å±‚["ğŸ§  çŠ¶æ€ç®¡ç†å±‚"]
        SM["AgentState çŠ¶æ€æœº"]
        S1["connecting"]
        S2["initializing"]
        S3["listening"]
        S4["thinking"]
        S5["speaking"]
        SM --> S1
        SM --> S2
        SM --> S3
        SM --> S4
        SM --> S5
    end

    subgraph æ˜ å°„æ ¸å¿ƒ["âš¡ ä¸“åˆ©æ˜ å°„æ ¸å¿ƒ (å®æ—¶æ˜ å°„ç®—æ³•)"]
        direction TB
        CH1["é€šé“1: æƒ…æ„Ÿ â†’ é¢œè‰² Color<br/>(EmotionType â†’ HSLè‰²å½©)"]
        CH2["é€šé“2: ç‰¹å¾ â†’ å½¢æ€ Shape<br/>(Pitch+Volume â†’ æŒ¯å¹…/é—´è·/æ¡æ•°)"]
        CH3["é€šé“3: èŠ‚å¥ â†’ åŠ¨æ€ Dynamic<br/>(Speed+Volume â†’ é€Ÿåº¦/æ¨¡å¼/å‘å…‰)"]
        LERP_ALL["å…¨é€šé“æ’å€¼å™¨<br/>(Lerpå¹³æ»‘è¿‡æ¸¡)"]
        CH1 --> LERP_ALL
        CH2 --> LERP_ALL
        CH3 --> LERP_ALL
    end

    subgraph åŠ¨ç”»å¼•æ“å±‚["ğŸ¬ åŠ¨ç”»å¼•æ“å±‚"]
        SEQ["åºåˆ—ç”Ÿæˆå™¨"]
        RAF["requestAnimationFrame<br/>åŠ¨ç”»å¾ªç¯ (60fps)"]
        SEQ --> RAF
    end

    subgraph æ¸²æŸ“å±‚["ğŸ¨ æ¸²æŸ“å±‚"]
        subgraph Canvasæ¸²æŸ“["Canvas æ¸²æŸ“å™¨"]
            CLC["ç»å…¸æ³¢å½¢"]
            IOS9["iOS9å¤šè‰²æ³¢å½¢"]
        end
        subgraph DOMæ¸²æŸ“["DOM æ¸²æŸ“å™¨"]
            BAR["æ¡å½¢å¯è§†åŒ–å™¨"]
            GRID["ç½‘æ ¼å¯è§†åŒ–å™¨"]
            RADIAL["å¾„å‘å¯è§†åŒ–å™¨"]
        end
    end

    subgraph è¾“å‡ºå±‚["ğŸ“º æƒ…æ„Ÿå¯è§†åŒ–è¾“å‡º"]
        HAPPY["ğŸ˜Š å¼€å¿ƒ Happy<br/>é’è“è‰²Â·é«˜æŒ¯å¹…Â·æ´»è·ƒ"]
        SAD["ğŸ˜¢ éš¾è¿‡ Sad<br/>ç´«è‰²Â·ä½æŒ¯å¹…Â·ç¨€ç–"]
        CALM["ğŸ˜Œ å¹³é™ Calm<br/>ç™½ç°è‰²Â·å‡åŒ€Â·é™æ­¢"]
    end

    UI --> SM
    UI --> THEME
    THEME --> æ¸²æŸ“å±‚

    VOL --> CH2
    VOL --> CH3
    PITCH --> CH2
    SPEED --> CH3
    EMO --> CH1

    SM --> SEQ
    LERP_ALL --> RAF

    RAF --> CLC
    RAF --> IOS9
    RAF --> BAR
    RAF --> GRID
    RAF --> RADIAL

    CLC --> HAPPY
    CLC --> SAD
    CLC --> CALM
    BAR --> HAPPY
    BAR --> SAD
    BAR --> CALM

    classDef userLayer fill:#4A90D9,stroke:#2C5F8A,color:#fff
    classDef audioLayer fill:#2ECC71,stroke:#1A9B4B,color:#fff
    classDef stateLayer fill:#7B68EE,stroke:#5A4FCF,color:#fff
    classDef mappingLayer fill:#00BCD4,stroke:#0097A7,color:#fff
    classDef animLayer fill:#F39C12,stroke:#D68910,color:#fff
    classDef renderLayer fill:#E74C3C,stroke:#C0392B,color:#fff
    classDef outputLayer fill:#1A1A2E,stroke:#00BCD4,color:#fff

    class UI,THEME userLayer
    class MIC,VOL,PITCH,SPEED,EMO audioLayer
    class SM,S1,S2,S3,S4,S5 stateLayer
    class CH1,CH2,CH3,LERP_ALL mappingLayer
    class SEQ,RAF animLayer
    class CLC,IOS9,BAR,GRID,RADIAL renderLayer
    class HAPPY,SAD,CALM outputLayer
