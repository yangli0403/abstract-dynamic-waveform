stateDiagram-v2
    [*] --> connecting: 初始化

    connecting --> initializing: WebRTC连接建立
    connecting --> disconnected: 连接失败

    initializing --> listening: 代理就绪
    initializing --> disconnected: 初始化失败

    listening --> thinking: 用户发送消息
    listening --> speaking: 检测到语音活动(VAD)
    listening --> disconnected: 连接断开

    thinking --> speaking: AI开始回复
    thinking --> listening: AI无回复(超时)
    thinking --> disconnected: 连接断开

    speaking --> listening: 语音结束
    speaking --> thinking: 用户打断后AI重新思考
    speaking --> disconnected: 连接断开

    disconnected --> connecting: 重新连接
    disconnected --> [*]: 会话结束

    state connecting {
        [*] --> 建立WebRTC连接
        建立WebRTC连接 --> 信令交换
        信令交换 --> ICE候选收集
    }

    state thinking {
        [*] --> 处理用户输入
        处理用户输入 --> 生成回复
        生成回复 --> 准备语音合成
    }

    state speaking {
        [*] --> 播放音频
        播放音频 --> 音量分析
        音量分析 --> 驱动可视化
        驱动可视化 --> 播放音频
    }
