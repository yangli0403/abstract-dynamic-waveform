graph TD
    subgraph ç”¨æˆ·å±‚["ğŸ¤ ç”¨æˆ·äº¤äº’å±‚"]
        MIC["éº¦å…‹é£è¾“å…¥"]
        UI["UIæ§åˆ¶é¢æ¿"]
        THEME["ä¸»é¢˜/æ ·å¼é…ç½®"]
    end

    subgraph çŠ¶æ€ç®¡ç†å±‚["ğŸ§  çŠ¶æ€ç®¡ç†å±‚"]
        SM["AgentState çŠ¶æ€æœº"]
        SM -->|connecting| S1["è¿æ¥ä¸­"]
        SM -->|initializing| S2["åˆå§‹åŒ–ä¸­"]
        SM -->|listening| S3["è†å¬ä¸­"]
        SM -->|thinking| S4["æ€è€ƒä¸­"]
        SM -->|speaking| S5["è¯´è¯ä¸­"]
    end

    subgraph éŸ³é¢‘å¤„ç†å±‚["ğŸ”Š éŸ³é¢‘å¤„ç†å±‚"]
        AA["éŸ³é¢‘åˆ†æå™¨<br/>(Web Audio API)"]
        MB["å¤šé¢‘æ®µåˆ†è§£<br/>(FFT â†’ N bands)"]
        VOL["éŸ³é‡è®¡ç®—<br/>(RMS/Peak)"]
    end

    subgraph åŠ¨ç”»å¼•æ“å±‚["ğŸ¬ åŠ¨ç”»å¼•æ“å±‚"]
        SEQ["åºåˆ—ç”Ÿæˆå™¨"]
        LERP["æ’å€¼å¼•æ“<br/>(Lerpå¹³æ»‘è¿‡æ¸¡)"]
        RAF["requestAnimationFrame<br/>åŠ¨ç”»å¾ªç¯"]
    end

    subgraph æ¸²æŸ“å±‚["ğŸ¨ æ¸²æŸ“å±‚"]
        subgraph Canvasæ¸²æŸ“["Canvas æ¸²æŸ“å™¨ (SiriWaveè·¯çº¿)"]
            CLC["ç»å…¸æ³¢å½¢<br/>(è¡°å‡å‡½æ•°+æ­£å¼¦å åŠ )"]
            IOS9["iOS9å¤šè‰²æ³¢å½¢<br/>(åŠ¨æ€ç”Ÿæˆ/æ¶ˆäº¡)"]
        end
        subgraph DOMæ¸²æŸ“["DOM æ¸²æŸ“å™¨ (LiveKitè·¯çº¿)"]
            BAR["æ¡å½¢å¯è§†åŒ–å™¨"]
            GRID["ç½‘æ ¼å¯è§†åŒ–å™¨"]
            RADIAL["å¾„å‘å¯è§†åŒ–å™¨"]
        end
    end

    subgraph è¾“å‡ºå±‚["ğŸ“º è¾“å‡ºå±‚"]
        CANVAS["Canvaså…ƒç´ "]
        DOMOUT["DOMå…ƒç´ ç»„"]
    end

    MIC --> AA
    UI --> SM
    UI --> THEME
    THEME --> Canvasæ¸²æŸ“
    THEME --> DOMæ¸²æŸ“

    AA --> MB
    MB --> VOL
    VOL --> LERP

    SM --> SEQ
    SEQ --> RAF
    LERP --> RAF

    RAF --> CLC
    RAF --> IOS9
    RAF --> BAR
    RAF --> GRID
    RAF --> RADIAL

    CLC --> CANVAS
    IOS9 --> CANVAS
    BAR --> DOMOUT
    GRID --> DOMOUT
    RADIAL --> DOMOUT

    classDef userLayer fill:#4A90D9,stroke:#2C5F8A,color:#fff
    classDef stateLayer fill:#7B68EE,stroke:#5A4FCF,color:#fff
    classDef audioLayer fill:#2ECC71,stroke:#1A9B4B,color:#fff
    classDef animLayer fill:#F39C12,stroke:#D68910,color:#fff
    classDef renderLayer fill:#E74C3C,stroke:#C0392B,color:#fff
    classDef outputLayer fill:#1ABC9C,stroke:#16A085,color:#fff

    class MIC,UI,THEME userLayer
    class SM,S1,S2,S3,S4,S5 stateLayer
    class AA,MB,VOL audioLayer
    class SEQ,LERP,RAF animLayer
    class CLC,IOS9,BAR,GRID,RADIAL renderLayer
    class CANVAS,DOMOUT outputLayer
